<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	
		<title><%= title %></title>
	
		<link rel="stylesheet" href="/dist/reset.css">
		<link rel="stylesheet" href="/dist/reveal.css">
		<link rel="stylesheet" href="/dist/theme/<%= theme %>.css">
	
			<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="/plugin/highlight/monokai.css">

		<!-- Font awesome is required for the chalkboard plugin -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

		<link rel="stylesheet" href="/plugin/chalkboard/style.css">
		<link rel="stylesheet" href="/plugin/customcontrols/style.css">


	</head>
	<body>
		<div class="reveal">
			<% if (locals.footer) { %>
				<%- include('footer.html') %>
			<% } %>
			<div class="slides">
				<% if (locals.slides) { %>
					<%- include('slides.html') %>
				<% } else { %>
					<section data-markdown="./slides.md" data-separator="^(\r)?\n(\r)?---(\r)?\n(\r)?$" data-separator-vertical="^(\r)?\n(\r)?--(\r)?\n(\r)?$"></section>
				<% } %>
			</div>
		</div>
		
		<script src="/dist/reveal.js"></script>
		<script src="/plugin/notes/notes.js"></script>
		<script src="/plugin/markdown/markdown.js"></script>
		<script src="/plugin/highlight/highlight.js"></script>
        <script src="/plugin/math/math.js"></script>
		<script src="/plugin/zoom/zoom.js"></script>
		<script src="/plugin/search/search.js"></script>
		<script src="/plugin/chalkboard/plugin.js"></script>
		<script src="/plugin/customcontrols/plugin.js"></script>
		<script src="/plugin/anything/plugin.js"></script>
		<script src="/libs/pdfjs/build/pdf.mjs" type="module"></script>
		
		<% if (locals.scripts) { %>
			<%- include('scripts.html') %>	
		<% } %>
		<script>
			
				// More info about initialization & config:
				// - https://revealjs.com/initialization/
				// - https://revealjs.com/config/
				Reveal.initialize({
					hash: true,
					history: true,
					pdfSeparateFragments : false,
					// Use the default (h.v), because the printed version will always have this anyway
					slideNumber: 'true',
					showNotes: false,
					customcontrols: {
						controls: [
						{ icon: '<i class="fa fa-pen-square"></i>',
							title: 'Toggle chalkboard (B)',
							action: 'RevealChalkboard.toggleChalkboard();'
						},
						{ icon: '<i class="fa fa-pen"></i>',
							title: 'Toggle notes canvas (C)',
							action: 'RevealChalkboard.toggleNotesCanvas();'
						},
						]
					},
					// Learn about plugins: https://revealjs.com/plugins/
					plugins: [ 
						// Interpret Markdown in <section> elements
						RevealMarkdown, 
						// Syntax highlight for <code> elements
						RevealHighlight,
						// Speaker notes
						RevealNotes, 
						// Zoom in and out with Ctrl+Alt+click
						RevealZoom,
						RevealMath,
						// Search slides  with Ctrl+Shift+f
						RevealSearch,
						RevealChalkboard,
						RevealCustomControls,
						RevealAnything
						],
						anything: [
							{className: "pdf",
							defaults: {},
							initialize: (function(container, options){

								// <iframe src="/libs/pdfjs/web/viewer.html?file=lix-236-433.pdf" width="100%" height="500"></iframe>
								var url = options.pdf;
								var pdf = document.createElement('iframe');
								pdf.src = '/libs/pdfjs/web/viewer.html?file=' + window.location.origin +'/' + '<%- folder %>' + '/' + options.pdf;
								pdf.width = '100%';
								pdf.height = '500';
								container.appendChild(pdf);
							}
							)},
							{
							className: "pdf-old",
							defaults: {},
							initialize: (function(container, options){
								var url = options.pdf;
								// Loaded via <script> tag, create shortcut to access PDF.js exports.
								var { pdfjsLib } = globalThis;
								// The workerSrc property shall be specified.
								pdfjsLib.GlobalWorkerOptions.workerSrc = '/libs/pdfjs/build/pdf.worker.mjs';
								// Asynchronous download of PDF
								var loadingTask = pdfjsLib.getDocument(url);
								loadingTask.promise
									.then((pdf) => {
										for (let i = 1; i <= pdf.numPages; i++) {
											canvasId = appendCanvasForPDFPage(container);
											renderPDFPage(pdf, i, canvasId);
										}									
									}, function (reason) {
									// PDF loading error
									console.error(reason);
									});
								}
								)
							},
							],
				});

				function appendCanvasForPDFPage(container){
					var canvas = document.createElement('canvas');
					canvas.id = 'canvas-' + Math.random().toString(36).substr(2, 9);
					container.appendChild(canvas);
					return canvas.id;
				}

				function renderPDFPage(pdf, pageNumber, canvasId){
					pdf
						.getPage(pageNumber)
						.then((page) => {
							console.log('Page loaded', canvas);
							var scale = 1.5;
							var viewport = page.getViewport({scale: scale});
							// Prepare canvas using PDF page dimensions
							var canvas = document.getElementById(canvasId);
							var context = canvas.getContext('2d');
							canvas.height = viewport.height;
							canvas.width = viewport.width;
							// Render PDF page into canvas context
							var renderContext = {
								canvasContext: context,
								viewport: viewport
							};
							var renderTask = page.render(renderContext);
						});
				}
				
		</script>
		<% if (locals.body_end) { %>
			<%- include(body_end) %>
		<% } %>
	</body>
</html>
